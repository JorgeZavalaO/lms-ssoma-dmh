# üìö M√≥dulos del Sistema

Este documento describe todos los m√≥dulos implementados en el LMS SSOMA DMH.

## √çndice R√°pido

- **M√≥dulo K**: Certificados (Emisi√≥n y Verificaci√≥n P√∫blica)
- **M√≥dulo J**: Reportes (√Åreas, Curso, Cumplimiento)
- **M√≥dulo I**: Notificaciones y Recordatorios
- **M√≥dulo H**: Progreso y Cumplimiento
- **M√≥dulo F**: Evaluaciones Automatizadas
- **M√≥dulo E**: Inscripciones y Accesos
- **M√≥dulo D**: Contenidos Interactivos
- **M√≥dulo C**: Cat√°logo de Cursos
- **M√≥dulo B**: Asignaciones y Rutas
- **M√≥dulo A**: Usuarios y Autenticaci√≥n

---

## üìú M√≥dulo K: Certificados (Emisi√≥n y Verificaci√≥n P√∫blica)

Estado: ‚úÖ **100% Completado**

Sistema completo de emisi√≥n autom√°tica de certificados PDF con c√≥digos de verificaci√≥n √∫nicos y QR codes, m√°s verificaci√≥n p√∫blica sin autenticaci√≥n.

### K1. Emisi√≥n Autom√°tica de Certificados

**Prop√≥sito**: Generar certificados PDF profesionales al aprobar cursos.

**Caracter√≠sticas**:
- **Plantilla Profesional**:
  - Dise√±o landscape (A4 horizontal) con bordes dobles
  - Marca de agua "SSOMA" en segundo plano
  - Informaci√≥n completa: nombre, DNI, curso, nota, horas
  - QR code para verificaci√≥n r√°pida
  - C√≥digo de verificaci√≥n √∫nico de 16 caracteres
  - N√∫mero de certificado √∫nico
  - Fecha de emisi√≥n y vencimiento
  - Firma digital del responsable de SSOMA

- **Generaci√≥n de PDF**:
  - Tecnolog√≠a: `@react-pdf/renderer` 4.3.1
  - Estilos CSS-in-JS con StyleSheet
  - Renderizado server-side con `renderToBuffer()`
  - Template en React: `certificate-template.tsx`

- **C√≥digos de Verificaci√≥n**:
  - Generaci√≥n con `crypto.randomBytes(8)` ‚Üí 16 chars hex uppercase
  - √önicos por certificado (√≠ndice √∫nico en BD)
  - QR code apunta a `/verify/[code]`
  - Espacio de b√∫squeda: 2^64 combinaciones

- **Almacenamiento**:
  - `pdfUrl`: URL del PDF generado
  - `verificationCode`: C√≥digo √∫nico indexado
  - `qrCode`: QR en base64
  - `pdfMetadata`: { size, generatedAt }

**API Endpoints**:
```
POST /api/certificates/generate
  Body: { certificationId: string }
  Auth: Solo ADMIN
  Response: { success, certificateId, verificationCode, pdfUrl }

GET /api/certificates/[id]/download
  Params: id (certification ID)
  Auth: Autenticado
  Response: PDF file con headers de descarga

GET /api/certificates
  Query: collaboratorId, courseId, isValid, hasVerificationCode, startDate, endDate
  Auth: Solo ADMIN
  Response: { certificates: Array, total: number }
```

**Flujo de Generaci√≥n**:
1. Admin solicita generaci√≥n desde `/admin/certificates`
2. POST a `/api/certificates/generate`
3. `getCertificateData()` obtiene datos del certificado
4. Genera `verificationCode` si no existe
5. Genera QR code con URL de verificaci√≥n
6. Guarda c√≥digo y QR en base de datos
7. `CertificateTemplate({ data })` crea estructura
8. `renderToBuffer()` genera PDF
9. Retorna PDF para descarga

**Archivo**: `src/lib/certificates.ts` (240 l√≠neas)

---

### K2. Verificaci√≥n P√∫blica de Certificados

**Prop√≥sito**: Permitir verificaci√≥n de autenticidad por terceros sin autenticaci√≥n.

**Caracter√≠sticas**:
- **Acceso P√∫blico**:
  - Ruta: `/verify/[code]`
  - Sin autenticaci√≥n requerida
  - Accesible por QR scan o ingreso manual

- **Estados Visuales**:
  - ‚úÖ Verde: Certificado v√°lido y vigente
  - ‚ö†Ô∏è Amarillo/Naranja: Certificado expirado
  - ‚ùå Rojo: Certificado no encontrado/inv√°lido

- **Informaci√≥n P√∫blica Mostrada** (datos m√≠nimos):
  - N√∫mero de certificado
  - Nombre del colaborador (sin datos sensibles)
  - Nombre del curso
  - Fecha de emisi√≥n
  - Fecha de vencimiento (si aplica)
  - Duraci√≥n del curso (horas)
  - Calificaci√≥n obtenida (%)
  - Estado de validez actual

- **Validaci√≥n de Vigencia**:
  - Verifica `isValid = true` en base de datos
  - Verifica `expiresAt >= now()` si aplica
  - Badge visual con estado del certificado

**API Endpoint**:
```
GET /api/certificates/verify/[code]
  Params: code (16 chars hex)
  Auth: Ninguna (p√∫blico)
  Response: {
    valid: boolean,
    certificate: {
      certificateNumber, collaboratorName, courseName,
      issuedAt, expiresAt, courseHours, score, isValid
    }
  }
```

**Flujo de Verificaci√≥n**:
1. Usuario escanea QR o ingresa c√≥digo
2. Navegador abre `/verify/[code]`
3. GET a `/api/certificates/verify/[code]`
4. `verifyCertificate(code)` busca en BD
5. Valida `isValid && !isExpired`
6. Retorna datos p√∫blicos
7. Muestra p√°gina con estado visual

**Archivo**: `src/app/verify/[code]/page.tsx` (240 l√≠neas)

---

### P√°gina de Administraci√≥n

**Ruta**: `/admin/certificates`

**Funcionalidades**:
- Listado de todos los certificados emitidos
- Tabla con: N¬∞ Certificado, Colaborador, Curso, Emisi√≥n, Estado
- Acciones disponibles:
  - **Generar**: Crea PDF si no existe c√≥digo
  - **Descargar**: Descarga certificado generado
  - **Verificar**: Abre p√°gina de verificaci√≥n p√∫blica
- Filtros por colaborador, curso, estado de validez
- Badges de estado (v√°lido/inv√°lido)

**Archivo**: `src/app/admin/certificates/page.tsx` (210 l√≠neas)

---

### Schema de Base de Datos

**Extensi√≥n de `CertificationRecord`**:
```prisma
model CertificationRecord {
  // ... campos existentes ...
  pdfUrl            String?        // URL del PDF generado
  verificationCode  String?  @unique // C√≥digo √∫nico
  qrCode            String?        // QR en base64
  pdfMetadata       Json?          // { size, generatedAt }
}
```

**Migraci√≥n**: `20251017060346_add_certificate_pdf_fields`

---

### Dependencias

**Producci√≥n**:
- `@react-pdf/renderer@4.3.1` - Generaci√≥n de PDFs desde React
- `qrcode@1.5.4` - Generaci√≥n de c√≥digos QR

**Desarrollo**:
- `@types/qrcode@1.5.5` - Tipos TypeScript

---

### Seguridad

**C√≥digos √önicos**:
- Generaci√≥n con `crypto.randomBytes` (seguro)
- √çndice √∫nico en base de datos
- 16 caracteres hexadecimales (2^64 combinaciones)

**Datos P√∫blicos**:
- Solo informaci√≥n m√≠nima necesaria
- No expone email, direcci√≥n, tel√©fono, IDs internos
- Datos acad√©micos contextuales √∫nicamente

**Autorizaci√≥n**:
- Generaci√≥n: Solo `ADMIN`
- Descarga: Usuarios autenticados
- Verificaci√≥n: P√∫blico (by design)

---

### M√©tricas

**L√≠neas de C√≥digo**: 1,220 l√≠neas totales
- `certificates.ts`: 240 l√≠neas (service)
- `certificate-template.tsx`: 260 l√≠neas (component)
- API routes: 235 l√≠neas (4 endpoints)
- Pages: 450 l√≠neas (2 p√°ginas)
- Validations: 35 l√≠neas (schemas)

**Archivos Creados**: 9 archivos
- 1 service layer
- 1 component (template PDF)
- 4 API routes
- 2 p√°ginas (admin + verify)
- 1 validation file

---

## üìä M√≥dulo J: Reportes (√Åreas, Curso, Cumplimiento)

Estado: ‚úÖ **100% Completado**

Sistema completo de reportes anal√≠ticos, dashboards ejecutivos y matrices de cumplimiento SSOMA con visualizaciones interactivas.

### J1. Dashboard Ejecutivo

**Prop√≥sito**: Panel de control con KPIs en tiempo real para direcci√≥n ejecutiva.

**KPIs Principales**:
- Colaboradores activos vs total
- % Cumplimiento general por √°rea
- Tasa de aprobaci√≥n y promedio de evaluaciones
- Alertas cr√≠ticas (vencidos + pr√≥ximos 7/30 d√≠as)

**Visualizaciones**:
- Gr√°fico de barras: Cumplimiento por √°rea
- Gr√°fico circular: Distribuci√≥n de alertas por estado
- Gr√°fico de √°rea: Tendencia de inscripciones (30 d√≠as)
- Gr√°fico de l√≠neas: Tendencia de completaciones (30 d√≠as)
- Top 5 cursos cr√≠ticos con contadores

**Filtros**: Rango temporal (7, 30, 90 d√≠as, todo), √°rea, sede

**Endpoint**: `GET /api/reports/dashboard`

### J2. Reporte por √Årea

**Prop√≥sito**: Listado detallado de colaboradores con estado por curso.

**Columnas**:
- DNI, Nombre completo, √Årea, Puesto
- Curso asignado, Estado, Progreso (%), Calificaci√≥n

**Filtros Avanzados**:
- Por √°rea, sede, puesto, estado del curso
- Por curso espec√≠fico, rango de fechas de inscripci√≥n

**Exportaci√≥n**: XLSX, CSV, PDF (preparado)

**Endpoint**: `GET /api/reports/area`

### J3. Reporte por Curso

**Prop√≥sito**: Estad√≠sticas detalladas de un curso espec√≠fico.

**M√©tricas**:
- Total inscritos, Tasa de completaci√≥n (%)
- Tasa de aprobaci√≥n (%), Promedio de calificaci√≥n
- Tiempo promedio de completaci√≥n (minutos)

**An√°lisis**:
- Distribuci√≥n de calificaciones en 5 rangos (0-20, 21-40, etc.)
- Distribuci√≥n de estados (PASSED, IN_PROGRESS, FAILED, EXPIRED)
- Informaci√≥n de versi√≥n activa del curso

**Endpoint**: `GET /api/reports/course?courseId=...`

### J4. Reporte de Cumplimiento Legal/SSOMA

**Prop√≥sito**: Matriz de cumplimiento de cursos obligatorios con sem√°foro de vigencia.

**Sem√°foro**:
- üü¢ **Verde (COMPLIANT)**: Curso vigente y al d√≠a
- üü° **Amarillo (EXPIRING_SOON)**: Vence en ‚â§30 d√≠as
- üî¥ **Rojo (EXPIRED/NOT_ENROLLED)**: Vencido o no inscrito

**Matriz**:
- Filas: Colaboradores (nombre, √°rea, puesto)
- Columnas: Cursos obligatorios (con validityMonths)
- Celdas: Icono + d√≠as hasta vencimiento

**Resumen**: Total colaboradores, Cumplen, Por vencer, Vencidos

**Endpoint**: `GET /api/reports/compliance`

### J5. Trazabilidad de Evaluaciones

**Prop√≥sito**: Historial completo de intentos de evaluaci√≥n para auditor√≠as.

**Campos de Auditor√≠a**:
- Timestamp exacto (fecha y hora)
- DNI y nombre del colaborador
- Curso y evaluaci√≥n
- Duraci√≥n del intento (minutos y segundos)
- Calificaci√≥n obtenida, Estado (COMPLETED/IN_PROGRESS/ABANDONED)
- Cantidad de respuestas registradas
- Direcci√≥n IP aproximada, User Agent

**B√∫squeda**: Por DNI, nombre de colaborador o curso en tiempo real

**Informaci√≥n**: Pol√≠tica de retenci√≥n y privacidad de datos

**Endpoint**: `GET /api/reports/audit-trail`

---

**Modelos de Datos**:
```prisma
Report           // Reportes generados con metadata
ReportSchedule   // Programaci√≥n recurrente (DAILY/WEEKLY/etc)
ReportExecution  // Historial de ejecuciones programadas
KPISnapshot      // Snapshots hist√≥ricos para an√°lisis
```

**Enums**:
- `ReportType`: DASHBOARD, AREA, COURSE, COMPLIANCE, AUDIT_TRAIL
- `ReportFormat`: JSON, XLSX, CSV, PDF
- `ScheduleFrequency`: DAILY, WEEKLY, MONTHLY, QUARTERLY, CUSTOM

**APIs**:
- `GET /api/reports/dashboard` - KPIs ejecutivos
- `GET /api/reports/area` - Reporte por √°rea
- `GET /api/reports/course` - Estad√≠sticas por curso
- `GET /api/reports/compliance` - Matriz de cumplimiento
- `GET /api/reports/audit-trail` - Trazabilidad

**Servicios** (`src/lib/reports.ts`):
- `getDashboardKPIs()` - Calcula todos los KPIs en tiempo real
- `getAreaReport()` - Genera reporte por √°rea
- `getCourseReport()` - Estad√≠sticas de curso
- `getComplianceReport()` - Matriz con sem√°foro
- `getAuditTrail()` - Historial de intentos
- `createKPISnapshot()` - Snapshot hist√≥rico

**Componentes UI**:
- `src/app/reports/dashboard/page.tsx` - Dashboard con recharts
- `src/app/reports/area/page.tsx` - Tabla con filtros
- `src/app/reports/course/page.tsx` - Estad√≠sticas y gr√°ficos
- `src/app/reports/compliance/page.tsx` - Matriz sem√°foro
- `src/app/reports/audit-trail/page.tsx` - Historial auditor√≠a

**Validaciones** (`src/validations/reports.ts`):
- DashboardFiltersSchema, AreaReportFiltersSchema
- CourseReportFiltersSchema, ComplianceReportFiltersSchema
- AuditTrailFiltersSchema, ExportReportSchema

**Dependencias**:
- `recharts` - Gr√°ficos interactivos (BarChart, PieChart, AreaChart, LineChart)
- `date-fns` - Manejo de fechas y formatos
- shadcn/ui `chart` component - Wrapper con theming

**Migraci√≥n**: `20251017051442_add_reports_module`

---

## üì¨ M√≥dulo I: Notificaciones y Recordatorios

Estado: ‚úÖ **100% Completado**

Sistema completo de notificaciones por email y bandeja interna con plantillas editables y preferencias personalizables.

### I1. Email y Bandeja Interna

**Prop√≥sito**: Notificar eventos importantes y recordatorios autom√°ticos.

**Eventos Soportados**:
- `NEW_ENROLLMENT`: Nueva asignaci√≥n de curso
- `REMINDER_30_DAYS`: Recordatorio 30 d√≠as antes de vencimiento
- `REMINDER_7_DAYS`: Recordatorio 7 d√≠as antes de vencimiento
- `REMINDER_1_DAY`: Recordatorio 1 d√≠a antes de vencimiento
- `COURSE_FAILED`: Desaprobaci√≥n de curso
- `CERTIFICATE_READY`: Certificado disponible
- `RECERTIFICATION_DUE`: Recertificaci√≥n pr√≥xima
- `TEAM_SUMMARY`: Resumen semanal para jefes

**Caracter√≠sticas**:
- Plantillas editables con variables din√°micas (`{{collaboratorName}}`, `{{courseName}}`, etc.)
- Canales configurables: EMAIL, IN_APP, BOTH
- Prioridades: LOW, MEDIUM, HIGH, URGENT
- Preferencias opt-in/out por tipo de notificaci√≥n
- Bandeja interna con marcadores de le√≠do/archivado
- Contador de notificaciones no le√≠das en tiempo real

**Modelos**:
- `NotificationTemplate`: Plantillas editables por tipo
- `Notification`: Notificaciones individuales
- `NotificationPreference`: Preferencias de usuario
- `NotificationLog`: Hist√≥rico de env√≠os masivos

### I2. Recordatorios al Jefe

**Prop√≥sito**: Resumen semanal de pendientes del equipo para jefes de √°rea.

**Caracter√≠sticas**:
- Generaci√≥n autom√°tica de res√∫menes por √°rea
- Estad√≠sticas del equipo: total colaboradores, cursos pendientes
- Alertas de cursos pr√≥ximos a vencer (7 d√≠as)
- Env√≠o programable por √°rea o sede
- Formato HTML y texto plano

**Funcionalidades**:
- Generaci√≥n manual desde admin
- Programaci√≥n autom√°tica (preparado para cron jobs)
- Filtros por √°rea/sede espec√≠fica
- Log de env√≠os con m√©tricas de √©xito/fallo

### Endpoints del M√≥dulo I

**Plantillas**:
```
GET    /api/notification-templates           - Listar plantillas
POST   /api/notification-templates           - Crear plantilla
GET    /api/notification-templates/[id]      - Obtener plantilla
PUT    /api/notification-templates/[id]      - Actualizar plantilla
DELETE /api/notification-templates/[id]      - Eliminar plantilla
```

**Notificaciones**:
```
GET    /api/notifications                    - Listar notificaciones
GET    /api/notifications/[id]               - Obtener notificaci√≥n
PATCH  /api/notifications/[id]               - Marcar le√≠da/archivada
DELETE /api/notifications/[id]               - Eliminar notificaci√≥n
GET    /api/notifications/unread-count       - Contador no le√≠das
POST   /api/notifications/mark-all-read      - Marcar todas le√≠das
```

**Generaci√≥n Autom√°tica**:
```
POST   /api/notifications/generate           - Generar recordatorios vencimiento
PUT    /api/notifications/generate           - Generar resumen equipo
```

**Preferencias**:
```
GET    /api/notification-preferences         - Obtener preferencias
PUT    /api/notification-preferences         - Actualizar preferencia
```

### Componentes UI

**Archivo**: `src/components/notifications/notification-bell.tsx`
- Icono de campana con badge de contador
- Dropdown con √∫ltimas 10 notificaciones
- Marcar como le√≠da al hacer clic
- Link a p√°gina completa de notificaciones
- Actualizaci√≥n autom√°tica cada 30 segundos

**P√°ginas**:
- `/notifications`: Vista completa con tabs (Todas/No Le√≠das/Archivadas)
- `/admin/notification-templates`: Gesti√≥n de plantillas (Admin/SuperAdmin)

### Validaciones

**Archivo**: `src/validations/notifications.ts`

Schemas:
- `CreateNotificationTemplateSchema`: Validaci√≥n de plantillas
- `UpdateNotificationTemplateSchema`: Actualizaci√≥n parcial
- `CreateNotificationSchema`: Notificaci√≥n individual
- `UpdateNotificationSchema`: Actualizar estado
- `UpdateNotificationPreferenceSchema`: Preferencias
- `SendBulkNotificationSchema`: Env√≠o masivo
- `GenerateExpirationRemindersSchema`: Recordatorios vencimiento
- `GenerateTeamSummarySchema`: Resumen para jefes

### Servicio de Notificaciones

**Archivo**: `src/lib/notifications.ts`

Funciones principales:
- `createNotification()`: Crear notificaci√≥n individual
- `createNotificationFromTemplate()`: Crear desde plantilla con variables
- `generateExpirationReminders()`: Generar recordatorios de vencimiento
- `generateTeamSummary()`: Generar resumen para jefes
- `markNotificationAsRead()`: Marcar como le√≠da
- `markAllNotificationsAsRead()`: Marcar todas
- `archiveNotification()`: Archivar
- `getUnreadNotifications()`: Obtener no le√≠das
- `countUnreadNotifications()`: Contar no le√≠das

### Integraci√≥n con Eventos

Eventos que disparan notificaciones autom√°ticas:
1. **Nueva Inscripci√≥n** ‚Üí `NEW_ENROLLMENT`
2. **Curso Desaprobado** ‚Üí `COURSE_FAILED`
3. **Certificado Generado** ‚Üí `CERTIFICATE_READY`
4. **Curso Pr√≥ximo a Vencer** ‚Üí `REMINDER_30_DAYS`, `REMINDER_7_DAYS`, `REMINDER_1_DAY`
5. **Recertificaci√≥n Pr√≥xima** ‚Üí `RECERTIFICATION_DUE`

### Programaci√≥n de Recordatorios

**Recomendaci√≥n**: Configurar cron jobs o Vercel Cron para ejecutar:

```typescript
// Recordatorios de vencimiento
// Ejecutar diariamente a las 8:00 AM
POST /api/notifications/generate
{
  "daysBeforeExpiration": 30,
  "notificationType": "REMINDER_30_DAYS"
}

// Resumen semanal para jefes
// Ejecutar cada lunes a las 9:00 AM
PUT /api/notifications/generate
{
  "sendEmail": true
}
```

### Variables Disponibles en Plantillas

- `{{collaboratorName}}`: Nombre del colaborador
- `{{courseName}}`: Nombre del curso
- `{{courseCode}}`: C√≥digo del curso
- `{{dueDate}}`: Fecha de vencimiento
- `{{daysRemaining}}`: D√≠as restantes
- `{{score}}`: Puntuaci√≥n obtenida
- `{{certificateNumber}}`: N√∫mero de certificado

---

## üìä M√≥dulo H: Progreso y Cumplimiento

Estado: ‚úÖ **100% Completado**

### E1: Asignaci√≥n Autom√°tica por Perfil

**Prop√≥sito**: Inscribir autom√°ticamente colaboradores en cursos seg√∫n su sede/√°rea/puesto.

**Componentes**:
- Modelo `EnrollmentRule`: Define criterios (courseId, siteId, areaId, positionId)
- Servicio `applyAutoEnrollmentRules()`: Busca reglas coincidentes y crea inscripciones
- UI: `/admin/enrollment-rules` - Gesti√≥n CRUD de reglas

**Endpoints**:
```
GET    /api/enrollment-rules          - Listar todas las reglas
POST   /api/enrollment-rules          - Crear nueva regla
GET    /api/enrollment-rules/[id]     - Obtener regla espec√≠fica
PUT    /api/enrollment-rules/[id]     - Actualizar regla
DELETE /api/enrollment-rules/[id]     - Eliminar regla
```

**Archivo**: `src/app/api/enrollment-rules/route.ts`

---

### E2.1: Inscripci√≥n Individual Manual

**Prop√≥sito**: Inscribir uno o m√°s colaboradores espec√≠ficos en un curso.

**Componentes**:
- Modal: `EnrollIndividualDialog`
- Selecci√≥n m√∫ltiple de colaboradores
- Validaci√≥n: curso + m√≠nimo 1 colaborador

**Endpoint**:
```
POST /api/enrollments
{
  "courseId": "string",
  "collaboratorIds": ["id1", "id2"],
  "notes": "string (opcional)"
}
```

**Archivo**: `src/app/api/enrollments/route.ts`

---

### E2.2: Inscripci√≥n Masiva por Filtros

**Prop√≥sito**: Inscribir m√∫ltiples colaboradores usando criterios de sede/√°rea/puesto.

**Componentes**:
- Modal: `EnrollBulkDialog` (checkboxes de filtros)
- Validaci√≥n: curso + m√≠nimo 1 filtro
- Transacciones ACID para consistencia

**Endpoint**:
```
POST /api/enrollments/bulk
{
  "courseId": "string",
  "filters": {
    "siteIds": ["id1"],
    "areaIds": ["id2"],
    "positionIds": ["id3"]
  },
  "notes": "string (opcional)"
}
```

**Caracter√≠sticas**:
- Upsert: evita duplicados
- Transacci√≥n: todo o nada
- Retorna cantidad inscrita

**Archivo**: `src/app/api/enrollments/bulk/route.ts`

---

### E2: Gesti√≥n de Inscripciones

**UI**: `/admin/enrollments`
- Tabla de inscripciones con filtros
- Estados: PENDING, ACTIVE, COMPLETED, CANCELLED
- Tipos: MANUAL, AUTOMATIC
- Eliminar inscripciones individuales

**Endpoints de Inscripciones**:
```
GET    /api/enrollments               - Listar todas
POST   /api/enrollments               - Crear individual/masiva
GET    /api/enrollments/[id]          - Obtener una
PUT    /api/enrollments/[id]          - Actualizar
DELETE /api/enrollments/[id]          - Eliminar
POST   /api/enrollments/bulk          - Masiva por filtros
```

---

### Validaciones Zod

**Archivo**: `src/validations/enrollment.ts`

```typescript
EnrollmentRuleSchema          // Crear/actualizar regla
ManualEnrollmentSchema        // Inscripci√≥n individual
BulkEnrollmentSchema          // Inscripci√≥n masiva
UpdateEnrollmentSchema        // Actualizar inscripci√≥n
```

---

### Enums

```typescript
enum EnrollmentStatus {
  PENDING    // Reci√©n inscrito
  ACTIVE     // Cursando
  COMPLETED  // Termin√≥
  CANCELLED  // Cancelado
}

enum EnrollmentType {
  AUTOMATIC  // Por regla E1
  MANUAL     // Por inscripci√≥n E2
}
```

---

## üìñ M√≥dulo D: Contenidos Interactivos

Estado: ‚úÖ **100% Completado**

### D1: Unidades y Lecciones

**Prop√≥sito**: Organizar contenido educativo en unidades y lecciones con multimedia.

**Modelos**:
- `Unit`: Unidad con t√≠tulo, descripci√≥n, orden
- `Lesson`: Lecci√≥n con tipo y contenido

**Tipos de Lecci√≥n**:
- VIDEO: URL YouTube/Vimeo
- PDF: Documento PDF
- PPT: Presentaci√≥n PowerPoint
- HTML: Contenido HTML personalizado
- SCORM: Paquete SCORM

**Endpoints**:
```
GET    /api/courses/[courseId]/units
POST   /api/courses/[courseId]/units
GET    /api/units/[unitId]
PUT    /api/units/[unitId]
DELETE /api/units/[unitId]

GET    /api/units/[unitId]/lessons
POST   /api/units/[unitId]/lessons
GET    /api/lessons/[lessonId]
PUT    /api/lessons/[lessonId]
DELETE /api/lessons/[lessonId]
```

---

### D1: Progreso de Aprendizaje

**Prop√≥sito**: Tracking autom√°tico de % visto y completado.

**Modelo**: `LessonProgress`
- Porcentaje de vista
- Marca de completado (configurable por threshold)
- Timestamps

**Endpoint**:
```
GET    /api/lessons/[lessonId]/progress
PUT    /api/lessons/[lessonId]/progress
```

---

### D2: Repositorio de Archivos

**Prop√≥sito**: Almacenar archivos versio‚Äãnados con Vercel Blob.

**Modelo**: `FileRepository`
- URL en Blob (acceso p√∫blico)
- Versionado de archivos
- Etiquetas para b√∫squeda
- Tipos: PDF, PPT, IMAGE, VIDEO, DOCUMENT, OTHER

**Endpoint**:
```
POST   /api/files              - Subir archivo
GET    /api/files              - Listar con filtros
```

**L√≠mites**:
- 10MB por archivo
- Almacenamiento en Vercel Blob

---

### D3: Actividades Interactivas

**Prop√≥sito**: Crear ejercicios con contenido HTML y shadcn components.

**Modelo**: `InteractiveActivity`
- Contenido HTML personalizado
- Intentos m√°ximos configurable
- Respuestas en JSON

**Modelo**: `ActivityAttempt`
- Registro de intentos
- Respuestas guardadas
- Puntuaci√≥n opcional

**Endpoint**:
```
POST   /api/activities         - Crear
GET    /api/activities         - Listar con filtros
```

---

## üõ§Ô∏è M√≥dulo C: Cat√°logo de Cursos

Estado: ‚úÖ **100% Completado**

### Caracter√≠sticas

- **CRUD Completo**: Crear, leer, actualizar, eliminar cursos
- **Estados**: DRAFT, PUBLISHED, ARCHIVED
- **Modalidades**: ASYNCHRONOUS, SYNCHRONOUS, BLENDED
- **Campos**: C√≥digo, nombre, objetivo, duraci√≥n, modalidad, vigencia, requisitos

### Versionado

Cada cambio significativo crea una nueva versi√≥n:
- Historial completo sin perder datos
- Visualizaci√≥n de versiones anteriores
- Rollback a versiones previas

### Endpoints

```
GET    /api/courses                   - Listar
POST   /api/courses                   - Crear
GET    /api/courses/assigned          - Cursos asignados al usuario
GET    /api/courses/[id]              - Obtener curso
PUT    /api/courses/[id]              - Actualizar
DELETE /api/courses/[id]              - Eliminar
```

---

## üõ£Ô∏è M√≥dulo B: Rutas de Aprendizaje

Estado: ‚úÖ **100% Completado**

### Caracter√≠sticas

- **Rutas**: Itinerarios ordenados de cursos
- **Prerequisitos**: Definir cursos que deben completarse antes
- **Cursos**: Obligatorios u opcionales
- **Orden**: Secuencia clara de aprendizaje

### Endpoints

```
GET    /api/learning-paths                 - Listar
POST   /api/learning-paths                 - Crear
GET    /api/learning-paths/[id]            - Obtener
PUT    /api/learning-paths/[id]            - Actualizar
DELETE /api/learning-paths/[id]            - Eliminar

GET    /api/learning-paths/[id]/courses    - Cursos en ruta
POST   /api/learning-paths/[id]/courses    - Agregar curso
```

---

## üë• M√≥dulo A: Usuarios y Autenticaci√≥n

Estado: ‚úÖ **100% Completado**

### Autenticaci√≥n

- NextAuth v5 con JWT
- Proveedores: Credentials, OAuth (configurable)
- Sesiones seguras

### Roles

```
SUPERADMIN     - Acceso total
ADMIN          - Gesti√≥n de contenido
COLLABORATOR   - Acceso estudiante
```

### Endpoints

```
POST   /api/auth/[...nextauth]        - Autenticaci√≥n
POST   /api/register                  - Registro
GET    /api/users/[id]/role           - Obtener rol
PUT    /api/users/[id]/role           - Cambiar rol
```

---

## üè¢ Gesti√≥n Organizacional

### Colaboradores

```
GET    /api/collaborators             - Listar
POST   /api/collaborators             - Crear
POST   /api/collaborators/import      - Importar CSV/XLSX
GET    /api/collaborators/[id]        - Obtener
PUT    /api/collaborators/[id]        - Actualizar
DELETE /api/collaborators/[id]        - Eliminar
```

**Campos**: DNI, nombre completo, email, sede, √°rea, puesto, fecha entrada

### √Åreas

```
GET    /api/areas                     - Listar
POST   /api/areas                     - Crear
GET    /api/areas/[id]                - Obtener
PUT    /api/areas/[id]                - Actualizar
DELETE /api/areas/[id]                - Eliminar
PUT    /api/areas/[id]/head           - Asignar jefe
```

### Puestos

```
GET    /api/positions                 - Listar
POST   /api/positions                 - Crear
GET    /api/positions/[id]            - Obtener
PUT    /api/positions/[id]            - Actualizar
DELETE /api/positions/[id]            - Eliminar
```

### Sedes

```
GET    /api/sites                     - Listar
POST   /api/sites                     - Crear
GET    /api/sites/[id]                - Obtener
PUT    /api/sites/[id]                - Actualizar
DELETE /api/sites/[id]                - Eliminar
```

---

## üìä Relaciones de Datos

```
Course
‚îú‚îÄ enrollmentRules (E1)
‚îú‚îÄ enrollments (E2)
‚îú‚îÄ units (D1)
‚îú‚îÄ courseVersions (C)
‚îî‚îÄ learningPathCourses (B)

Collaborator
‚îú‚îÄ enrollments (E)
‚îú‚îÄ area
‚îú‚îÄ position
‚îú‚îÄ site
‚îî‚îÄ assignmentHistory

LearningPath
‚îî‚îÄ learningPathCourses
   ‚îú‚îÄ course
   ‚îî‚îÄ prerequisite

Unit
‚îî‚îÄ lessons

Lesson
‚îî‚îÄ progress

Quiz
‚îú‚îÄ quizQuestions
‚îî‚îÄ attempts

Question
‚îú‚îÄ options
‚îî‚îÄ quizQuestions

QuizAttempt
‚îî‚îÄ quiz
```

---

## M√≥dulo F ‚Äî Evaluaciones Automatizadas

Sistema completo de evaluaciones con banco de preguntas, cuestionarios, calificaci√≥n autom√°tica y remediaci√≥n.

### F1. Banco de Preguntas

**Modelo**: `Question`

Tipos de preguntas soportados:
- `SINGLE_CHOICE`: Opci√≥n m√∫ltiple (una correcta)
- `MULTIPLE_CHOICE`: Opci√≥n m√∫ltiple (varias correctas)
- `TRUE_FALSE`: Verdadero/Falso
- `ORDER`: Ordenar elementos en secuencia
- `FILL_BLANK`: Completar espacios en blanco

Caracter√≠sticas:
- Metadatos: tema, dificultad (1-10), √≠ndice de discriminaci√≥n
- Feedback personalizado por respuesta correcta/incorrecta
- Explicaciones detalladas para cada pregunta
- Relaci√≥n con versi√≥n de curso (`courseVersionId`)
- Opciones de respuesta ordenadas (`QuestionOption`)

### F2. Cuestionarios

**Modelo**: `Quiz`

Par√°metros configurables:
- `passingScore`: Nota m√≠nima para aprobar (%)
- `maxAttempts`: N√∫mero m√°ximo de intentos (null = ilimitado)
- `timeLimit`: Tiempo l√≠mite en minutos (null = sin l√≠mite)
- `shuffleQuestions`: Aleatorizar orden de preguntas
- `shuffleOptions`: Aleatorizar orden de opciones
- `questionsPerAttempt`: Subset de preguntas por intento

Pol√≠ticas de visualizaci√≥n:
- `showCorrectAnswers`: Mostrar respuestas correctas tras env√≠o
- `showFeedback`: Mostrar feedback de preguntas
- `showScoreImmediately`: Mostrar puntuaci√≥n al instante

Estados:
- `DRAFT`: Borrador (editable, no disponible para estudiantes)
- `PUBLISHED`: Publicado (disponible para intentos)
- `ARCHIVED`: Archivado (hist√≥rico, no disponible)

### F3. Intentos y Calificaci√≥n

**Modelo**: `QuizAttempt`

Estados de intentos:
- `IN_PROGRESS`: En progreso (iniciado, no enviado)
- `SUBMITTED`: Enviado (pendiente calificaci√≥n)
- `GRADED`: Calificado
- `PASSED`: Aprobado (score >= passingScore)
- `FAILED`: Reprobado (score < passingScore)

Caracter√≠sticas:
- Tracking de tiempo empleado en segundos
- Respuestas almacenadas en JSON
- C√°lculo autom√°tico de score y puntos
- Validaci√≥n de l√≠mite de intentos
- Validaci√≥n de remediaci√≥n completada

### F4. Reintentos y Remediaci√≥n

Criterios:
- Si `status === FAILED`, se marca `requiresRemediation = true`
- Bloqueo de nuevo intento hasta que `remediationCompleted = true`
- Contenido de refuerzo opcional (`remediationContent`)
- Endpoint dedicado para marcar remediaci√≥n completada

### F5. Banco por Versi√≥n

Caracter√≠sticas:
- Campo `courseVersionId` en `Question` para relacionar preguntas con versiones
- Pool de preguntas espec√≠fico por versi√≥n de curso
- M√©tricas almacenadas: `difficulty`, `discriminationIndex`
- Preparado para an√°lisis psicom√©trico

### Endpoints del M√≥dulo F

**Preguntas**:
```
GET    /api/questions                 - Listar preguntas (con filtros)
POST   /api/questions                 - Crear pregunta
GET    /api/questions/[id]            - Obtener pregunta
PUT    /api/questions/[id]            - Actualizar pregunta
DELETE /api/questions/[id]            - Eliminar pregunta
```

**Cuestionarios**:
```
GET    /api/quizzes                   - Listar cuestionarios
POST   /api/quizzes                   - Crear cuestionario
GET    /api/quizzes/[id]              - Obtener cuestionario
PUT    /api/quizzes/[id]              - Actualizar cuestionario
DELETE /api/quizzes/[id]              - Eliminar cuestionario
POST   /api/quizzes/[id]/attempt      - Iniciar intento
```

**Intentos**:
```
POST   /api/attempts/[id]/submit      - Enviar respuestas y calificar
GET    /api/attempts/[id]             - Obtener resultado de intento
POST   /api/attempts/[id]/remediation - Marcar remediaci√≥n completada
```

### Validaciones del M√≥dulo F

**Archivo**: `src/validations/quiz.ts`

Schemas:
- `QuestionTypeSchema`: Enum de tipos de pregunta
- `QuizStatusSchema`: Enum de estados de quiz
- `AttemptStatusSchema`: Enum de estados de intento
- `CreateQuestionSchema`: Validaci√≥n de pregunta con opciones
  - Verifica n√∫mero de opciones seg√∫n tipo
  - Verifica n√∫mero de respuestas correctas
- `CreateQuizSchema`: Validaci√≥n de cuestionario con par√°metros
- `SubmitQuizAttemptSchema`: Validaci√≥n de respuestas
- `CompleteRemediationSchema`: Validaci√≥n de remediaci√≥n

### Enums del M√≥dulo F

```typescript
enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
  ORDER
  FILL_BLANK
}

enum QuizStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
  PASSED
  FAILED
}
```

---

## üîë Resumen de Endpoints

**Total**: 68+ endpoints RESTful

- Autenticaci√≥n & Usuarios: 5
- Colaboradores: 7
- √Åreas: 6
- Puestos: 5
- Sedes: 5
- Cursos: 6
- M√≥dulo C (Versiones): Incluido en cursos
- M√≥dulo B (Rutas): 7
- M√≥dulo D (Contenidos): 14
- M√≥dulo E (Inscripciones): 8
- M√≥dulo F (Evaluaciones): 8
- Administrativo: Varios

---

## üìù Validaci√≥n de Datos

**Archivo**: `src/validations/`

Todos los endpoints usan validaci√≥n Zod para:
- Tipado seguro
- Errores claros
- Generaci√≥n autom√°tica de tipos TypeScript

---

## üîê Seguridad

- ‚úÖ Autenticaci√≥n NextAuth requerida
- ‚úÖ Autorizaci√≥n por rol
- ‚úÖ Validaci√≥n Zod en servidor
- ‚úÖ CSRF protection autom√°tico
- ‚úÖ Transacciones ACID (Prisma)
- ‚úÖ Roles verificados en endpoints

---

## üé® Componentes UI (shadcn/ui)

Utilizados en toda la aplicaci√≥n:
- Dialog, Form, Input, Select, Button
- Table, Badge, Card, Textarea
- Checkbox, Alert, Accordion
- Toast (Sonner)

---

√öltima actualizaci√≥n: 2025-10-16
